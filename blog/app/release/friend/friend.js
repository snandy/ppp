SohuBlog.App.Friend={addGroupUrl:"/a/app/friend/group/add.do",updateGroupUrl:"/a/app/friend/group/update.do",deleteGroupUrl:"/a/app/friend/group/delete.do",addUrl:"/a/app/friend/friend/add.do",updateUrl:"/a/app/friend/friend/update.do",deleteUrl:"/a/app/friend/friend/delete.do",ignoreUrl:"/a/app/friend/fans/ignore.do",passUrl:"/a/app/friend/fans/pass.do",addMappingUrl:"/a/app/friend/friend/addmapping.do",deleteMappingUrl:"/a/app/friend/friend/delmapping.do",setPmUrl:"/a/app/friend/friend/setpm.do",dsaUrl:"/a/app/friend/friend/dsa.do",groupList:[],currentGroup:0,lastSearchKey:"",initView:function(){this.groupListHover();this.friendListHover();this.bindClickEvent();this.getCurGroupId();this.getAllGroups()},groupListHover:function(){$$(".f4 ul li").each(function(a){Event.observe(a,"mouseover",function(){$(this).addClassName("fgpact")}.bind(a));Event.observe(a,"mouseout",function(){$(this).removeClassName("fgpact")}.bind(a))})},friendListHover:function(){$$(".fri").each(function(a){Event.observe(a,"mouseover",function(){$(this).addClassName("friact")}.bind(a));Event.observe(a,"mouseout",function(){$(this).removeClassName("friact")}.bind(a))})},bindClickEvent:function(){var a=$$(".addfg a")[0];Event.observe(a,"click",this.toggleAddGroupForm.bind(this));$$(".f4 .fedit").each(function(b){Event.observe(b,"click",this.toggleModifyGroupForm.bindAsEventListener(this))}.bind(this));$$(".f4 .fdel").each(function(b){Event.observe(b,"click",this.deleteGroup.bindAsEventListener(this))}.bind(this));this.bindFriendListEvent();if($("search_key")){Event.observe($("search_key"),"input",this.searchFriend.bind(this));Event.observe($("search_key"),"propertychange",this.searchFriend.bind(this));Event.observe($("search_key"),"blur",function(){if($("search_key").value.trim()==""){$("search_key").value="搜索好友..."}});Event.observe($("search_key"),"click",function(){if($("search_key").value.trim()=="搜索好友..."){$("search_key").value=""}})}},bindFriendListEvent:function(){$$(".f3 .fgp").each(function(a){Event.observe(a,"click",this.toggleGroupSelector.bindAsEventListener(this))}.bind(this));$$(".f3 .fedit").each(function(a){Event.observe(a,"click",this.showModifyFriend.bindAsEventListener(this))}.bind(this));$$(".f3 .fdel").each(function(a){Event.observe(a,"click",this.showDeleteFriend.bindAsEventListener(this))}.bind(this))},binPrivacyTabEvent:function(){var a=$("privacy_form").down(".btn");Event.observe(a,"click",this.setPrivacySetting.bindAsEventListener(this))},binRequestTabEvent:function(){$$(".fri .btn").each(function(a){if(a.hasClassName("btn_dis")){Event.observe(a,"click",this.ignoreFriendRequest.bindAsEventListener(this))}else{Event.observe(a,"click",this.approveFriendRequest.bindAsEventListener(this))}}.bind(this))},getCurGroupId:function(){var c="";var b=window.location.toString().match(/^[^#]*(#.+)$/);if(b){c=b[1]}var a=0;if(c.indexOf("groupId=")!=-1){a=c.substring(c.indexOf("groupId=")+("groupId=".length));if(a.indexOf("&")!=-1){a=c.substring(c.indexOf("&")+("&".length))}a=parseInt(a);if(isNaN(a)){a=0}}this.currentGroup=a},toggleAddGroupForm:function(){var a=$$(".pop1")[0];if(a.visible()){a.hide()}else{a.show()}},addGroup:function(event,type){var srcEle=Event.element(event);var form=srcEle.up("form");var gname=form.gname.value.trim();if(gname==""){emptyContentAlert(form.gname);return}var pars="gname="+encodeURIComponent(gname);new Ajax.Request(this.addGroupUrl,{method:"post",parameters:pars,onComplete:function(response){if(response.status==200){eval("var json="+response.responseText);if(json){if(json.status==1){this.addGroupSuccessOnList(json);form.gname.value="";if(type&&type=="selector"){var fid=form.fid.value;this.addGroupSuccessOnSelector(json,fid)}this.getAllGroups()}else{Mini.MsgBox.alert(json.statusText);return}}}else{this.onError(response.status)}}.bind(this)})},addGroupSuccessOnList:function(c){var g=c.data;var e=c.data.gid;var d=c.data.gname;var b='<li class="" id="group_'+e+'"><a class="fedit" href="#"><i class="i-fedit"></i></a><a class="fdel" href="#"><i class="i-fdel"></i></a><h4><a href="/app/friend/friend/double.do?groupId='+e+'"><span>'+d+"</span><span>(<b>0</b>)</span></a></h4></li>";var f=$$(".f4 ul li");if(f.length>1){var a=f[f.length-2];new Insertion.After(a,b)}else{var a=$$(".f4 ul")[0];a.insert(b)}this.groupListHover()},addGroupSuccessOnSelector:function(a,d){var c=a.data;var b=a.data.gid;this.addGroupMapping(d,b)},toggleModifyGroupForm:function(f){var a=Event.element(f);var c=a.up("li");var e=c.id;e=e.substring("group_".length);Event.stop(f);if(!$("grpmd_"+e)){var h=new Element("li");h.id="grpmd_"+e;h.innerHTML='<form><h4><p><input type="text" name="gname" value=""></p><input name="gid" type="hidden" value='+e+'><p><a class="fgyes" href="javascript:void(0)"><b>确定</b></a><a class="fgno" href="javascript:void(0)"><b>取消</b></a></p></h4>';h.hide();h.addClassName("fgmod");var b=h.down(".fgyes");var g=h.down(".fgno");Event.observe(b,"click",this.modifyGroup.bindAsEventListener(this));Event.observe(g,"click",this.toggleModifyGroupForm.bindAsEventListener(this));$("group_"+e).insert({after:h})}if($("grpmd_"+e).visible()){$("grpmd_"+e).hide();$("group_"+e).show()}else{var d=c.down("h4 a span").innerHTML;$("grpmd_"+e).down("input").replace('<input type="text" name="gname" value="'+d+'">');$("grpmd_"+e).show();$("group_"+e).hide()}Event.stop(f)},modifyGroup:function(event){var srcEle=Event.element(event);var form=srcEle.up("form");var gid=form.gid.value.trim();var gname=form.gname.value.trim();if(gname==""){emptyContentAlert(form.gname);return}var pars="gname="+encodeURIComponent(gname)+"&gid="+gid;new Ajax.Request(this.updateGroupUrl,{method:"post",parameters:pars,onComplete:function(response){if(response.status==200){eval("var json="+response.responseText);if(json){if(json.status==1){var data=json.data;var gid=json.data.gid;var gname=json.data.gname;$("group_"+gid).down("h4 a span").innerHTML=gname;$("grpmd_"+gid).hide();$("group_"+gid).show();this.getAllGroups();return}else{Mini.MsgBox.alert(json.statusText);return}}}else{this.onError(response.status)}}.bind(this)})},deleteGroup:function(a){var b=' <p class="rep_c1">确定要删除分组吗？</p>                      <p class="rep_c2">提示：删除分组后，好友会被转移至未分组，不会丢失</p> ';Mini.MsgBox.confirmExt("",b,function(){this.doDeleteGroup(a)}.bind(this),"删除分组",false)},doDeleteGroup:function(event){var srcEle=Event.element(event);var itemContainer=srcEle.up("li");var gid=itemContainer.id;gid=gid.substring("group_".length);var pars="gid="+gid;new Ajax.Request(this.deleteGroupUrl,{method:"post",parameters:pars,onComplete:function(response){if(response.status==200){eval("var json="+response.responseText);if(json){if(json.status==1){$("group_"+gid).remove();this.getAllGroups();SohuBlog.App.getView();this.dsaInfo=null;return}else{Mini.MsgBox.alert(json.statusText);return}}}else{this.onError(response.status)}}.bind(this)});Event.stop(event)},onError:function(a){Mini.MsgBox.alert("服务器暂时没有响应")},getAllGroups:function(){var b=$$(".f4 ul li");var a=[];b.each(function(d){if(d.id&&d.id.indexOf("group_")!=-1){var e=d.id.substring("group_".length);var c=d.down("h4 span").innerHTML;if(parseInt(e)>0){a.push({id:e,name:c})}}});this.groupList=a;return a},toggleGroupSelector:function(b){var h=Event.element(b);if(h.className!="fgp"){h=h.up(".fgp")}var e=h.getAttribute("fid").trim();var j=h.getAttribute("gids").trim();var c=j.split(",");var d=this.groupList;var f=$("gselctor_"+e);if(f){if(f.visible()){f.hide();Event.stop(b);return}}else{var f=new Element("div");f.id="gselctor_"+e;f.addClassName("popLayer");f.addClassName("pop2");f.hide();f.innerHTML='<div class="decor"><span class="tl"><span class="tr"><span class="br"><span class="bl"></span></span></span></span></div><div class="content"><ul></ul><form onsubmit="return false;"><p><input type="hidden" name="fid" value="'+e+'"><input type="text" name="gname" class="fgtxt" value="新建分组"><a class="fgyes" href="javascript:void(0)"><b>确定</b></a></p></form></div></div>';var m=f.down(".fgtxt");var a=f.down("a.fgyes");Event.observe(m,"focus",function(){if(m.value.trim()=="新建分组"){m.value=""}});Event.observe(m,"blur",function(){if(m.value.trim()==""){m.value="新建分组"}});Event.observe(a,"click",function(n){this.addGroup(n,"selector")}.bindAsEventListener(this));$("canvas").insert(f)}var l=f.down("ul");var i="";d.each(function(n){i+='<li><label class="chkbox"><input type="checkbox" id="'+n.id+'"';if(SohuBlog.Util.inArr(c,n.id)){i+=" checked"}i+=">"+n.name+"</label></li>"});l.innerHTML=i;var g=document.getElementsByClassName("chkbox",l);g.each(function(p){var n=p.down("input");var o=function(){if(n.checked){this.addGroupMapping(e,n.id)}else{this.deleteGroupMapping(e,n.id)}};if(Browser.ua.indexOf("ie")>-1){Event.observe(n,"propertychange",o.bind(this))}else{Event.observe(n,"change",o.bind(this))}}.bind(this));var k=Position.cumulativeOffset(h);k=[k[0],(k[1]+parseInt(h.offsetHeight))];f.setStyle({left:k[0]+"px",top:k[1]+"px"});f.show();outEvent([f,h],function(){f.hide();return true}.bind(this))},getGroupNameStr:function(b){var a=this.groupList;var e="";for(var d=0;d<b.length;d++){var f=b[d];for(var c=0;c<a.length;c++){if(f==a[c].id){e+=a[c].name+",";break}}}if(e.length>0){e=e.substring(0,e.length-1)}e=Mini.Util.limitU(e,17);return e},updateGroupMemberCount:function(b,a){if($("group_"+b)){var c=$("group_"+b).down("span",1).innerHTML.toLowerCase();c=c.replace("<b>","").replace("</b>","").replace("(","").replace(")","");var d=parseInt(c.trim());if(isNaN(d)){d=0}$("group_"+b).down("span",1).innerHTML="(<b>"+(d+a)+"</b>)"}},updateAllGroupMemberCount:function(b,a){var c=b.split(",");this.updateGroupMemberCount(0,a);c.each(function(d){this.updateGroupMemberCount(d,a)}.bind(this))},addGroupMapping:function(friendId,groupId){var pars="friendid="+friendId+"&groupid="+groupId;new Ajax.Request(this.addMappingUrl,{method:"post",parameters:pars,onComplete:function(response){if(response.status==200){eval("var json="+response.responseText);if(json){if(json.status==1){$("gselctor_"+friendId).hide();var switcher=$("gswi_"+friendId);var idstr=switcher.getAttribute("gids");var oldIdStr=idstr;var idArr=idstr.split(",");if(!SohuBlog.Util.inArr(idArr,groupId)){idArr.push(groupId);idstr+=","+groupId}if(this.currentGroup==-1){var fri=switcher.up(".fri");this.updateGroupMemberCount(groupId,+1);this.updateGroupMemberCount(-1,-1);Mini.Vision.slideRemove(fri,{step:5,interval:30,type:"remove"})}else{if(oldIdStr==""){this.updateGroupMemberCount(-1,-1)}switcher.setAttribute("gids",idstr);var groupStr=this.getGroupNameStr(idArr);switcher.innerHTML="<b>"+groupStr+"</b>";this.updateGroupMemberCount(groupId,1)}if(this.dsaInfo){this.updateDsaGroups(friendId,idstr)}return}else{Mini.MsgBox.alert(json.statusText);return}}}else{this.onError(response.status)}}.bind(this)})},deleteGroupMapping:function(friendId,groupId){var pars="friendid="+friendId+"&groupid="+groupId;new Ajax.Request(this.deleteMappingUrl,{method:"post",parameters:pars,onComplete:function(response){if(response.status==200){eval("var json="+response.responseText);if(json){if(json.status==1){$("gselctor_"+friendId).hide();var switcher=$("gswi_"+friendId);var idstr=switcher.getAttribute("gids");var idArr=idstr.split(",");if(SohuBlog.Util.inArr(idArr,groupId)){idArr=idArr.without(groupId);idstr=idArr.join(",")}switcher.setAttribute("gids",idstr);var groupStr=this.getGroupNameStr(idArr);if(this.currentGroup!=0&&groupId==this.currentGroup.toString()){var fri=switcher.up(".fri");this.updateGroupMemberCount(groupId,-1);Mini.Vision.slideRemove(fri,{step:5,interval:30,type:"remove"})}else{if(groupStr==""){groupStr="未分组";this.updateGroupMemberCount(-1,1)}switcher.innerHTML="<b>"+groupStr+"</b>";this.updateGroupMemberCount(groupId,-1)}if(this.dsaInfo){this.updateDsaGroups(friendId,idstr)}return}else{Mini.MsgBox.alert(json.statusText);return}}}else{this.onError(response.status)}}.bind(this)})},showModifyFriend:function(event){var srcEle=Event.element(event);if(srcEle.className!="fedit"){srcEle=srcEle.up(".fedit")}var desc="";var fin=srcEle.up(".fri").down(".fin");var fnk=fin.down(".fnk");if(fnk){desc=fnk.down("b").innerHTML}var friendId=srcEle.getAttribute("fid").trim();var sub=srcEle.getAttribute("sub").trim();var str='<form id="modFriForm" onsubmit="return false;"><div class="repost">	<div class="mwc3"><div class="mwc31">好友标识：<input type="text" name="desc" value="'+desc+'" class="txt"><input type="hidden" value="'+friendId+'" name="fid" class="txt"></div><label class="chkbox"><input type="checkbox" '+((sub=="0")?"checked":"")+' name="subscribe">不再接受该好友的动态</label></div></div></form>';Mini.MsgBox.confirmExt("",str,function(){var form=$("modFriForm");var desc=form.desc.value.trim();var fid=form.fid.value.trim();var subscribe=(form.subscribe.checked)?'0':'1';var pars="friendid="+fid+"&desc="+encodeURIComponent(desc)+"&subscribe="+subscribe;new Ajax.Request(this.updateUrl,{method:"post",parameters:pars,onComplete:function(response){if(response.status==200){eval("var json="+response.responseText);if(json){if(json.status==1){if(fnk){fnk.innerHTML="<b>"+json.data.desc+"</b>"}if(this.dsaInfo){this.updateDsaMyDesc(fid,json.data.desc)}srcEle.setAttribute("sub",subscribe);return}else{Mini.MsgBox.alert(json.statusText);return}}}else{this.onError(response.status)}}.bind(this)})}.bind(this),"修改好友信息",false)},showDeleteFriend:function(event){var srcEle=Event.element(event);if(srcEle.className!="fdel"){srcEle=srcEle.up(".fdel")}var friendId=srcEle.getAttribute("fid").trim();var name="";var fri=srcEle.up(".fri");var fin=fri.down(".fin");var fnm=fin.down(".fnm");if(fnm){name=fnm.down("a").innerHTML}var str='<div class="mwc3">你确定从好友中删除 '+name+" 吗？<br>提示：删除后将解除好友关系，你也不会再收到他的最新动态</div>";Mini.MsgBox.confirmExt("",str,function(){var pars="friendid="+friendId;new Ajax.Request(this.deleteUrl,{method:"post",parameters:pars,onComplete:function(response){if(response.status==200){eval("var json="+response.responseText);if(json){if(json.status==1){var gsw=$("gswi_"+friendId);var gids=gsw.getAttribute("gids").trim();if(gids==""){gids="-1"}this.updateAllGroupMemberCount(gids,-1);Mini.Vision.slideRemove(fri,{step:5,interval:30,type:"remove"});if(this.dsaInfo){this.removeFromDsa(friendId)}return}else{Mini.MsgBox.alert(json.statusText);return}}}else{this.onError(response.status)}}.bind(this)})}.bind(this),"删除好友",false)},setPrivacySetting:function(event){var radios=$("privacy_form").pm;var privacy=0;for(var i=0;i<radios.length;i++){if(radios[i].checked){privacy=radios[i].value;break}}var pars="pmflag="+privacy;new Ajax.Request(this.setPmUrl,{method:"post",parameters:pars,onComplete:function(response){if(response.status==200){eval("var json="+response.responseText);if(json){if(json.status==1){Mini.MsgBox.alert("设置成功");return}else{Mini.MsgBox.alert(json.statusText);return}}}else{this.onError(response.status)}}.bind(this)})},ignoreFriendRequest:function(event){var srcEle=Event.element(event);var friItem=srcEle.up(".fri");var id=friItem.id;id=id.substring("fansid_".length);var pars="fansid="+id;new Ajax.Request(this.ignoreUrl,{method:"post",parameters:pars,onComplete:function(response){if(response.status==200){eval("var json="+response.responseText);if(json){if(json.status==1){Mini.Vision.slideRemove(friItem,{step:15,interval:30,type:"remove"});return}else{Mini.MsgBox.alert(json.statusText);return}}}else{this.onError(response.status)}}.bind(this)})},approveFriendRequest:function(event){var srcEle=Event.element(event);var friItem=srcEle.up(".fri");var id=friItem.id;id=id.substring("fansid_".length);var pars="fansid="+id;new Ajax.Request(this.passUrl,{method:"post",parameters:pars,onComplete:function(response){if(response.status==200){eval("var json="+response.responseText);if(json){if(json.status==1){Mini.Vision.slideRemove(friItem,{step:5,interval:30,type:"remove"});var friInfo=json.data.friend;this.addToDsa(friInfo);return}else{Mini.MsgBox.alert(json.statusText);return}}}else{this.onError(response.status)}}.bind(this)})},getDsa:function(){if(this.dsaInfo==null){new Ajax.Request(this.dsaUrl,{method:"get",parameters:"",onComplete:function(response){if(response.status==200){eval("var json="+response.responseText);if(json){if(json.status==1){this.dsaInfo=json.data.friends;this.doSearch();return}else{Mini.MsgBox.alert(json.statusText);return}}}else{this.onError(response.status)}}.bind(this)})}},genFriendItem:function(a){var c=this.getGroupNameStr(a.gids.split(","));if(c==""){c="未分组"}var b='<div class="fri">	                    <div class="fra">	                     	<a href="'+a.url+'"><img src="'+a.icon+'"></a>	                    </div>	               <span gids="'+a.gids+'" fid="'+a.id+'" id="gswi_'+a.id+'" class="fgp">	                   <b>'+c+'</b></span>                        <span fid="'+a.id+'" class="fedit"><a href="javascript:void(0)"><i class="i i-fedit"></i>编辑</a></span>                        <span fid="'+a.id+'" class="fdel"><a href="javascript:void(0)"><i class="i i-fdel"></i>删除</a></span>                        <div class="fr0">                            <p class="fin"><span class="fnm"><a href="'+a.url+'">'+a.name+'</a></span><span class="fnk"><b>'+a.mydesc+'</b></span></p>                            <p class="fde">'+a.desc+"</p>                        </div>                    </div>";return b},searchFriend:function(){if(!this.dsaInfo){this.getDsa()}else{this.doSearch()}},doSearch:function(){var b=$("search_key").value.trim();if(b=="搜索好友..."){return}if(this.lastSearchKey==b){return}this.lastSearchKey=b;var a=[];this.searchName(b,a);var c="";a.each(function(d){c+=this.genFriendItem(d)}.bind(this));if(c==""){c=' <div class="mytip">没有找到匹配的好友，你可以换一些搜索关键词</div>'}$$(".fris")[0].innerHTML=c;if($$(".pg").length>0){$$(".pg")[0].innerHTML=""}setTimeout(function(){this.bindFriendListEvent();this.friendListHover()}.bind(this),10)},searchName:function(b,c){if(this.dsaInfo){for(var a=0;a<this.dsaInfo.length;a++){var d=this.dsaInfo[a];if(d.name.indexOf(b)!=-1||d.pinyin.indexOf(b)!=-1||d.shouzimu.indexOf(b)!=-1){c.push(d)}}}},removeFromDsa:function(b){if(this.dsaInfo){for(var a=0;a<this.dsaInfo.length;a++){var c=this.dsaInfo[a];if(c.id.toString()==b){this.dsaInfo=this.dsaInfo.without(c)}}}},addToDsa:function(b){if(this.dsaInfo){for(var a=0;a<this.dsaInfo.length;a++){var c=this.dsaInfo[a];if(c.id==b.id){return}}}this.dsaInfo.push(b)},updateDsaMyDesc:function(b,d){if(this.dsaInfo){for(var a=0;a<this.dsaInfo.length;a++){var c=this.dsaInfo[a];if(c.id.toString()==b){this.dsaInfo[a].mydesc=d}}}},updateDsaGroups:function(c,a){if(this.dsaInfo){for(var b=0;b<this.dsaInfo.length;b++){var d=this.dsaInfo[b];if(d.id.toString()==c){this.dsaInfo[b].gids=a}}}}};