/******* Menu Js For Sohu Personal Portal Page **********/
//	Author: Todd Lee (www.todd-lee.com)
//	First Created: 2005-02-23
//	Last Update: 2006-08-17
//	Copyright: Sohu.com (www.sohu.com)
/********************************************************/
Menus={menus:[],defaultZIndex:1500,cancelHideFlag:false,frmCountTime:0,register:function(menu){if(this.menus.length===0){this.eventMouseClick=this.hideAll.bindAsEventListener(this);Event.observe(document,"click",this.eventMouseClick);}this.menus.push(menu);},unregister:function(menu){this.menus=this.menus.reject(function(m){return m==menu;});if(this.menus.length===0){Event.stopObserving(document,"click",this.eventMouseClick);}},hideSubMenu:function(m){m.hideSubMenu();m.showing=false;Element.removeClassName(m.element,m.options.overCss);Element.removeClassName(m.element,m.options.downCss);Element.removeClassName(m.arrow,m.options.aOverCss);Element.removeClassName(m.arrow,m.options.aDownCss);},hideAll:function(mustHide){if(this.cancelHideFlag){this.ableHide();return;}this.defaultZIndex=1000;this.menus.each(function(m){if(m.element&&m.arrow&&(mustHide==true||m.options.clickDomToClose)){Menus.hideSubMenu(m);}});},cancelHide:function(){this.cancelHideFlag=true;},ableHide:function(){this.cancelHideFlag=false;},buildFrameShadow:function(){var frm=document.createElement('iframe');this.frm=frm;frm.style.position='absolute';frm.frameborder='0';frm.style.border='none';Element.hide(frm);document.body.appendChild(frm);}};Menu=Class.create();Menu.prototype={initialize:function(name,element,subElement,options){this.subMenus=[];this.name=name;if($(element)){this.element=$(element);}else{this.elementObj=element;}if($(subElement)&&$(subElement).tagName){this.subElement=$(subElement);}else{this.subElementObj=subElement;}this.adv=(!this.elementObj&&!this.element)?true:false;this.options=Object.extend({outCss:'menu-out',overCss:'menu-over',downCss:'menu-down',disableCss:'menu-disabled',aOutCss:'menuArrow-out',aOverCss:'menuArrow-over',aDownCss:'menuArrow-down',aDisableCss:'menuArrow-disabled',sDivCss:'menuSub-div',itDivCss:'subMenu-title',isDivCss:'menuInnerSub-div',sOutCss:'menuSub-out',sOverCss:'menuSub-over',sDownCss:'menuSub-down',sDisableCss:'menuSub-disabled',sActiveCss:'menuSub-active',placeIn:document.body,subMenuPlaceIn:null,hideOthers:true,buttonOnly:false,setActive:false,defaultActive:null,clickToClose:false,clickDomToClose:true,dynamicLoadSubmenu:false,disabled:false,beforeShow:null,onShow:null,beforeHide:null,onHide:null},options||{});this.showing=false;this.build();if(this.options.disabled){this.disableMenu();}Menus.register(this);},build:function(){this.buildMenu();if(!this.options.buttonOnly){this.buildArrow();this.buildSubMenu();}},buildMenu:function(){if(!this.element){var divMenu=document.createElement('div');this.element=divMenu;if(!this.adv){divMenu.innerHTML=this.elementObj;}}Element.addClassName(this.element,this.options.outCss);this.eventCancelBubble=App.cancelBubble.bindAsEventListener(this);Event.observe(this.element,'click',this.eventCancelBubble);this.eventMouseOver=this.mouseOver.bindAsEventListener(this);Event.observe(this.element,'mouseover',this.eventMouseOver);this.eventMouseOut=this.mouseOut.bindAsEventListener(this);Event.observe(this.element,'mouseout',this.eventMouseOut);Event.observe(this.element,'blur',this.eventMouseOut);this.eventMouseDown=this.mouseDown.bindAsEventListener(this);Event.observe(this.element,'mousedown',this.eventMouseDown);this.eventMouseUp=this.mouseUp.bindAsEventListener(this);Event.observe(this.element,'mouseup',this.eventMouseUp);this.eventMouseClick=this.mouseClick.bindAsEventListener(this);if(!this.adv){if(!this.options.buttonOnly){Event.observe(this.element,'click',this.eventMouseClick);}}else{this.setMenuDefault();}if(this.options.placeIn&&$(this.options.placeIn)){$(this.options.placeIn).appendChild(this.element);}},buildArrow:function(){if(!this.subElement&&!this.subElementObj){return;}var divArrow=document.createElement('div');this.arrow=divArrow;Element.addClassName(divArrow,this.options.aOutCss);divArrow.innerHTML='<img src="'+App.Actions.imgPath+'spacer.gif" />';Event.observe(this.arrow,'click',this.eventCancelBubble);Event.observe(this.arrow,'mouseover',this.eventMouseOver);Event.observe(this.arrow,'mouseout',this.eventMouseOut);Event.observe(this.arrow,'blur',this.eventMouseOut);Event.observe(this.arrow,'mousedown',this.eventMouseDown);Event.observe(this.arrow,'mouseup',this.eventMouseUp);Event.observe(this.arrow,'click',this.eventMouseClick);var nextElement=this.element.nextSibling||null;if(!nextElement){this.element.parentNode.appendChild(this.arrow);}else{this.element.parentNode.insertBefore(this.arrow,nextElement);}},buildSubMenu:function(){if(!this.subElement&&this.subElementObj){var divSubMenu=document.createElement('div');this.subElement=divSubMenu;divSubMenu.className=this.options.sDivCss;}if(this.options.dynamicLoadSubmenu){divSubMenu.innerHTML=App.Lang.loading;}else{}Element.hide(divSubMenu);divSubMenu.style.position='absolute';Event.observe(divSubMenu,'click',this.eventCancelBubble);if(this.options.subMenuPlaceIn&&$(this.options.subMenuPlaceIn)){$(this.options.subMenuPlaceIn).appendChild(divSubMenu);}else if(this.options.placeIn&&$(this.options.placeIn)){$(this.options.placeIn).appendChild(divSubMenu);}},buildStatSubMenu:function(){if(App.Permit.ableLog){$LT('Menu.buildStatSubMenu');}if(!this.subElement){return;}var divSubMenu=this.subElement;$A(this.subElementObj).each(function(sb,i){if(sb.tit){var divSubMenuBoxTit=document.createElement('div');divSubMenuBoxTit.className=this.options.itDivCss;divSubMenuBoxTit.innerHTML=sb.tit;divSubMenu.appendChild(divSubMenuBoxTit);}if(sb.cont&&sb.cont.length>0){var divInnerSubMenu=document.createElement('div');divInnerSubMenu.className=this.options.isDivCss+' clearfix';$A(sb.cont).each(function(sm,j){sm={index:i+'_'+j,text:sm.text||'',title:sm.title||'',action:sm.action||Prototype.emptyFunction,value:sm.value||null,disabled:sm.disabled||false};var divSubMenuLine=document.createElement('div');sm.element=divSubMenuLine;Element.addClassName(divSubMenuLine,this.options.sOutCss);if(sm.disabled){Element.addClassName(divSubMenuLine,this.options.sDisableCss);}divSubMenuLine.innerHTML=sm.text;if(sm.text){divSubMenuLine.title=(sm.title||sm.text);}var eventSubMouseClick=function(){if(sm.disabled){return function(){};}if(this.adv){setPref('menu_'+this.name,sm.index);this.setMenuDefault();}if(this.options.setActive){setPref('menu_'+this.name,sm.index);this.setSubMenuActive();}if(this.options.clickToClose){this.hideSubMenu();this.showing=false;Element.removeClassName(this.element,this.options.overCss);Element.removeClassName(this.element,this.options.downCss);Element.removeClassName(this.arrow,this.options.aOverCss);Element.removeClassName(this.arrow,this.options.aDownCss);}return(sm.action)(sm.value);}.bindAsEventListener(this);if(!sm.disabled){Event.observe(divSubMenuLine,'click',eventSubMouseClick);Event.observe(divSubMenuLine,'mouseover',this.eventMouseOver);Event.observe(divSubMenuLine,'mouseout',this.eventMouseOut);Event.observe(divSubMenuLine,'mousedown',this.eventMouseDown);Event.observe(divSubMenuLine,'mouseup',this.eventMouseUp);}divInnerSubMenu.appendChild(divSubMenuLine);this.subMenus.push(sm);}.bind(this));divSubMenu.appendChild(divInnerSubMenu);}}.bind(this));if(this.options.setActive){this.setSubMenuActive(this.options.defaultActive);}if(App.Permit.ableLog){$LT('Menu.buildStatSubMenu end');}},buildDynaSubMenu:function(){if(App.Permit.ableLog){$LT('Menu.buildDynaSubMenu');}if(!this.subElement){return;}var divSubMenu=this.subElement;divSubMenu.innerHTML='';var divInnerSubMenu=document.createElement('div');divInnerSubMenu.className=this.options.isDivCss;this.subElementObjArr=(this.subElementObj)();if(this.subElementObjArr.length<=0){return;}$A(this.subElementObjArr).each(function(sm,i){sm={index:i,text:sm.text||'',title:sm.title||'',action:sm.action||Prototype.emptyFunction,value:sm.value||null,disabled:sm.disabled||false};var divSubMenuLine=document.createElement('div');sm.element=divSubMenuLine;Element.addClassName(divSubMenuLine,this.options.sOutCss);if(sm.disabled){Element.addClassName(divSubMenuLine,this.options.sDisableCss);}divSubMenuLine.innerHTML=sm.text;if(sm.text){divSubMenuLine.title=(sm.title||sm.text);}var eventSubMouseClick=function(){if(sm.disabled){return function(){};}if(this.adv){setPref('menu_'+this.name,i);this.setMenuDefault();}if(this.options.setActive){setPref('menu_'+this.name,i);this.setSubMenuActive();}if(this.options.clickToClose){this.hideSubMenu();this.showing=false;Element.removeClassName(this.element,this.options.overCss);Element.removeClassName(this.element,this.options.downCss);Element.removeClassName(this.arrow,this.options.aOverCss);Element.removeClassName(this.arrow,this.options.aDownCss);}return(sm.action)(sm.value,divSubMenuLine);}.bindAsEventListener(this);if(!sm.disabled){Event.observe(divSubMenuLine,'click',eventSubMouseClick);Event.observe(divSubMenuLine,'mouseover',this.eventMouseOver);Event.observe(divSubMenuLine,'mouseout',this.eventMouseOut);Event.observe(divSubMenuLine,'mousedown',this.eventMouseDown);Event.observe(divSubMenuLine,'mouseup',this.eventMouseUp);}divInnerSubMenu.appendChild(divSubMenuLine);this.subMenus.push(sm);}.bind(this));if(this.options.setActive){this.setSubMenuActive(this.options.defaultActive);}divSubMenu.appendChild(divInnerSubMenu);if(App.Permit.ableLog){$LT('Menu.buildDynaSubMenu end');}},mouseOver:function(event){if(this.options.disabled){return;}var eventElm=Event.element(event);if(this.isChildOf(eventElm,this.element)){if(!this.showing||this.adv){Element.addClassName(this.element,this.options.overCss);}if(!this.showing&&!this.adv){Element.addClassName(this.arrow,this.options.aOverCss);}}else if(this.isChildOf(eventElm,this.arrow)){if(!this.showing){Element.addClassName(this.arrow,this.options.aOverCss);if(!this.adv){Element.addClassName(this.element,this.options.overCss);}}}else if(this.isChildOf(eventElm,this.subElement)){Element.addClassName(this.getSubMenuLine(eventElm),this.options.sOverCss);}},mouseOut:function(event){if(this.options.disabled){return;}var eventElm=Event.element(event);if(this.isChildOf(eventElm,this.element)){if(!this.showing||this.adv){Element.removeClassName(this.element,this.options.overCss);Element.removeClassName(this.element,this.options.downCss);}if(!this.showing&&!this.adv){Element.removeClassName(this.arrow,this.options.aOverCss);Element.removeClassName(this.arrow,this.options.aDownCss);}}else if(this.isChildOf(eventElm,this.arrow)){if(!this.showing){Element.removeClassName(this.arrow,this.options.aOverCss);Element.removeClassName(this.arrow,this.options.aDownCss);if(!this.adv){Element.removeClassName(this.element,this.options.overCss);Element.removeClassName(this.element,this.options.downCss);}}}else if(this.isChildOf(eventElm,this.subElement)){Element.removeClassName(this.getSubMenuLine(eventElm),this.options.sOverCss);Element.removeClassName(this.getSubMenuLine(eventElm),this.options.sDownCss);}},mouseDown:function(event){if(this.options.disabled){return;}var eventElm=Event.element(event);if(this.isChildOf(eventElm,this.element)){Element.addClassName(this.element,this.options.downCss);if(!this.adv){Element.addClassName(this.arrow,this.options.aDownCss);}}else if(this.isChildOf(eventElm,this.arrow)){Element.addClassName(this.arrow,this.options.aDownCss);if(!this.adv){Element.addClassName(this.element,this.options.downCss);}}else if(this.isChildOf(eventElm,this.subElement)){Element.addClassName(this.getSubMenuLine(eventElm),this.options.sDownCss);}},mouseUp:function(event){if(this.options.disabled){return;}var eventElm=Event.element(event);if(this.isChildOf(eventElm,this.element)){Element.removeClassName(this.element,this.options.downCss);if(!this.adv){Element.removeClassName(this.arrow,this.options.aDownCss);}}else if(this.isChildOf(eventElm,this.arrow)){Element.removeClassName(this.arrow,this.options.aDownCss);if(!this.adv){Element.removeClassName(this.element,this.options.downCss);}}else if(this.isChildOf(eventElm,this.subElement)){Element.removeClassName(this.getSubMenuLine(eventElm),this.options.sDownCss);}},setMenuDefault:function(){if(!this.adv){return;}var id=getPref('menu_'+this.name)||0;if(this.subElementObj&&this.subElementObj[id]){var subMenu=this.subElementObj[id];this.element.innerHTML=subMenu.text||'';this.element.title=subMenu.title||subMenu.text||'';var eventSubMouseClick=function(){if(this.options.disabled){return function(){};}if(subMenu.action){return(subMenu.action)(subMenu.value);}}.bindAsEventListener(this);Event.observe(this.element,'click',eventSubMouseClick);}},setSubMenuActive:function(active){if(!this.options.setActive){return;}this.subMenus.each(function(sm){Element.removeClassName(sm.element,this.options.sActiveCss);if(active){if(sm.value==active){Element.addClassName(sm.element,this.options.sActiveCss);}}else{var id=getPref('menu_'+this.name)||0;if(sm.index==id){Element.addClassName(sm.element,this.options.sActiveCss);}}}.bind(this));},isChildOf:function(element,parentElement){do{if(element==parentElement){return true;}element=element.parentNode;}while(element);return false;},getSubMenuLine:function(element){do{if(element.parentNode&&Element.hasClassName(element,this.options.sOutCss)){return element;}element=element.parentNode;}while(element);return null;},mouseClick:function(){if(this.options.disabled){return;}this.showHideSubMenu();},disableMenu:function(){this.options.disabled=true;Element.addClassName(this.element,this.options.disableCss);if(this.arrow){Element.addClassName(this.arrow,this.options.aDisableCss);}},ableMenu:function(){this.options.disabled=false;Element.removeClassName(this.element,this.options.disableCss);if(this.arrow){Element.removeClassName(this.arrow,this.options.aDisableCss);}},showHideSubMenu:function(){if(this.showing){this.hideSubMenu();this.showing=false;if(!this.adv){Element.removeClassName(this.element,this.options.downCss);}Element.removeClassName(this.arrow,this.options.aDownCss);}else{if(this.options.dynamicLoadSubmenu){this.buildDynaSubMenu();}else if(this.subElement.innerHTML==''){this.buildStatSubMenu();}if(this.options.hideOthers){Menus.hideAll(true);}this.showSubMenu();this.showing=true;if(!this.adv){Element.addClassName(this.element,this.options.downCss);}Element.addClassName(this.arrow,this.options.aDownCss);}},showSubMenu:function(){if(this.showing){return;}var pos=Position.positionedOffset(this.element);this.subElement.style.left=pos[0]+'px';this.subElement.style.top=(pos[1]+parseInt(this.element.offsetHeight))+'px';this.subElement.style.zIndex=Menus.defaultZIndex++;if(this.options.beforeShow){(this.options.beforeShow)(this);}(Browser.ua.indexOf('ie')>=0)?Element.show(this.subElement):Effect.Appear(this.subElement,{duration:0.3,queue:{scope:this.name,position:'end'}});(Browser.ua.indexOf('ie')>=0)?this.showFrm():setTimeout(this.showFrm.bind(this),300);if(this.options.onShow){(this.options.onShow)(this);}},hideSubMenu:function(){if(!this.showing){return;}if(this.options.beforeHide){(this.options.beforeHide)(this);}(Browser.ua.indexOf('ie')>=0)?Element.hide(this.subElement):Effect.Fade(this.subElement,{duration:0.3,queue:{scope:this.name,position:'end'}});this.subElement.style.zIndex=0;this.hideFrm();if(this.options.onHide){(this.options.onHide)(this);}},showFrm:function(){if(Browser.ua=='ie5'||Browser.ua=='other'){return;}if(!Menus.frm){Menus.buildFrameShadow();}if(Menus.frm.offsetHeight!=this.subElement.offsetHeight||Menus.frm.offsetWidth!=this.subElement.offsetWidth){Menus.frm.style.left=this.subElement.style.left;Menus.frm.style.top=this.subElement.style.top;Menus.frm.style.zIndex=100;Element.show(Menus.frm);Menus.frm.style.width=this.subElement.offsetWidth+'px';Menus.frm.style.height=this.subElement.offsetHeight+'px';}clearTimeout(Menus.frmTimeout);Menus.frmTimeout=null;if(Menus.frmCountTime<=4){Menus.frmTimeout=setTimeout(this.showFrm.bind(this),500);Menus.frmCountTime++;}},hideFrm:function(){if(Menus.frm){clearTimeout(Menus.frmTimeout);Menus.frmTimeout=null;Menus.frmCountTime=0;Menus.frm.style.height='0px';Element.hide(Menus.frm);}}};